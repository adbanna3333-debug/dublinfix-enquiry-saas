<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DublinFix IT — Staff Inbox</title>
  <style>
    :root { --bg:#0b1220; --card:#121b2f; --muted:#9fb0d0; --txt:#e9f0ff; --accent:#6aa7ff; --bad:#ff6a6a; --ok:#7dffb2; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:linear-gradient(160deg,#070b14,#0b1220); color:var(--txt); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; }
    nav a { color:var(--muted); text-decoration:none; margin-left:12px; }
    nav a:hover { color:var(--txt); }
    .card { background: rgba(18,27,47,.85); border: 1px solid rgba(255,255,255,.08); border-radius: 18px; padding: 18px; box-shadow: 0 12px 30px rgba(0,0,0,.35); }
    .grid { display:grid; grid-template-columns: 360px 1fr; gap: 14px; }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    h1 { font-size: 20px; margin: 0 0 8px; }
    p { color: var(--muted); margin: 0 0 14px; }
    label { display:block; font-size: 13px; color: var(--muted); margin-top: 10px; }
    input, textarea, select {
      width:100%; box-sizing:border-box; margin-top:6px;
      background:#0b1327; color:var(--txt); border:1px solid rgba(255,255,255,.10);
      border-radius: 12px; padding: 10px 12px; outline:none;
    }
    textarea { min-height: 90px; resize: vertical; }
    button {
      margin-top: 12px;
      background: var(--accent); border: none; color:#061028; font-weight: 800;
      padding: 10px 12px; border-radius: 12px; cursor:pointer;
    }
    button.secondary { background: transparent; color: var(--txt); border:1px solid rgba(255,255,255,.14); }
    button:disabled { opacity:.65; cursor:not-allowed; }
    .msg { margin-top: 12px; padding: 10px 12px; border-radius: 12px; display:none; }
    .msg.ok { background: rgba(125,255,178,.12); border:1px solid rgba(125,255,178,.25); color: var(--ok); }
    .msg.bad { background: rgba(255,106,106,.12); border:1px solid rgba(255,106,106,.25); color: var(--bad); }
    .list { display:grid; gap: 10px; }
    .item { border:1px solid rgba(255,255,255,.10); border-radius: 16px; padding: 12px; background: rgba(11,19,39,.7); }
    .top { display:flex; justify-content:space-between; gap:10px; }
    .pill { font-size: 12px; padding: 4px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.14); color: var(--muted); }
    .title { font-weight: 800; }
    .meta { color: var(--muted); font-size: 12px; margin-top:4px; }
    .actions { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .small { font-size: 12px; color: var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .uidRow { display:flex; gap:10px; align-items:center; margin-top:10px; }
    .uidBox { flex:1; padding:10px 12px; border-radius:12px; background:#0b1327; border:1px solid rgba(255,255,255,.10); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div style="font-weight:800;">DublinFix IT</div>
        <div style="color:var(--muted); font-size:12px;">Staff Inbox (Realtime)</div>
      </div>
      <nav>
        <a href="public.html">Public</a>
        <a href="staff.html">Staff</a>
        <a href="insights.html">Insights</a>
      </nav>
    </header>

    <div class="grid">
      <div class="card" id="authCard">
        <h1>Staff login</h1>
        <p>Markers can use the demo credentials below.</p>

        <div class="small">
          Demo login:<br/>
          Email: <span class="mono">staff@nci-demo.ie</span><br/>
          Password: <span class="mono">Demo123!</span>
        </div>

        <label>Email</label>
        <input id="email" type="email" placeholder="staff@nci-demo.ie" />

        <label>Password</label>
        <input id="password" type="password" placeholder="••••••••" />

        <button id="loginBtn">Sign in</button>
        <button id="logoutBtn" class="secondary" style="display:none;">Sign out</button>

        <div id="authOk" class="msg ok"></div>
        <div id="authBad" class="msg bad"></div>

        <div id="uidSection" style="display:none; margin-top:12px;">
          <div class="small">
            Your UID (copy this EXACTLY and create Firestore doc ID <span class="mono">staff/{UID}</span>):
          </div>
          <div class="uidRow">
            <div id="uidText" class="uidBox mono"></div>
            <button id="copyUidBtn" class="secondary" style="margin-top:0;">Copy UID</button>
          </div>
          <div id="copyMsg" class="small" style="margin-top:8px; display:none; color:var(--ok);">Copied ✅</div>
        </div>
      </div>

      <div class="card" id="inboxCard" style="display:none;">
        <h1>Enquiry inbox</h1>
        <p>Live updates from Firestore (no refresh). Update status + notes.</p>

        <div id="inboxMsg" class="msg ok"></div>
        <div id="inboxErr" class="msg bad"></div>

        <div class="list" id="list"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc,
      query, orderBy, onSnapshot,
      updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // ✅ Your Firebase config (keep this exactly)
    const firebaseConfig = {
      apiKey: "AIzaSyBHl8DNvITATjqw2u8DhbopnHTPfDR_RiU",
      authDomain: "dublinfix-enquiry-saas.firebaseapp.com",
      projectId: "dublinfix-enquiry-saas",
      storageBucket: "dublinfix-enquiry-saas.firebasestorage.app",
      messagingSenderId: "677739653412",
      appId: "1:677739653412:web:5937442f4c01d075ceebb1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const inboxCard = document.getElementById("inboxCard");

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const authOk = document.getElementById("authOk");
    const authBad = document.getElementById("authBad");

    const uidSection = document.getElementById("uidSection");
    const uidText = document.getElementById("uidText");
    const copyUidBtn = document.getElementById("copyUidBtn");
    const copyMsg = document.getElementById("copyMsg");

    const inboxMsg = document.getElementById("inboxMsg");
    const inboxErr = document.getElementById("inboxErr");
    const list = document.getElementById("list");

    function show(el, text){ el.style.display="block"; el.textContent=text; }
    function hide(el){ el.style.display="none"; el.textContent=""; }

    let unsubscribe = null;

    async function checkStaffAccess(user){
      // Reads staff/{uid}. If denied by rules => throws. If allowed but missing => exists() false.
      const staffDocRef = doc(db, "staff", user.uid);
      const staffDoc = await getDoc(staffDocRef);
      return staffDoc.exists();
    }

    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function escapeAttr(str){ return escapeHtml(str).replace(/"/g, "&quot;"); }

    function renderItem(id, data){
      const created = data.createdAt?.toDate ? data.createdAt.toDate() : null;
      const createdText = created ? created.toLocaleString() : "just now";

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="top">
          <div>
            <div class="title">${escapeHtml(data.fullName || "Unknown")} — ${escapeHtml(data.topic || "Enquiry")}</div>
            <div class="meta">${escapeHtml(data.email || "")} • Created: ${escapeHtml(createdText)}</div>
          </div>
          <div class="pill">${escapeHtml(data.status || "New")}</div>
        </div>

        <div style="margin-top:10px; color:var(--muted); white-space:pre-wrap;">${escapeHtml(data.message || "")}</div>

        <div class="actions">
          <div>
            <label>Status</label>
            <select data-role="status">
              ${["New","In Progress","Resolved"].map(s => `<option ${data.status===s?"selected":""} value="${s}">${s}</option>`).join("")}
            </select>

            <label>Assigned to</label>
            <input data-role="assignedTo" value="${escapeAttr(data.assignedTo || "")}" placeholder="e.g., Aoife (Technician)" />
          </div>

          <div>
            <label>Internal notes</label>
            <textarea data-role="internalNotes" placeholder="Staff-only notes...">${escapeHtml(data.internalNotes || "")}</textarea>

            <button data-role="save">Save update</button>
          </div>
        </div>
      `;

      div.querySelector('[data-role="save"]').addEventListener("click", async () => {
        hide(inboxMsg); hide(inboxErr);

        const status = div.querySelector('[data-role="status"]').value;
        const assignedTo = div.querySelector('[data-role="assignedTo"]').value.trim();
        const internalNotes = div.querySelector('[data-role="internalNotes"]').value.trim();

        try {
          const patch = {
            status,
            assignedTo,
            internalNotes,
            updatedAt: serverTimestamp()
          };
          if (status === "Resolved") patch.resolvedAt = serverTimestamp();
          if (status !== "Resolved") patch.resolvedAt = null;

          await updateDoc(doc(db, "enquiries", id), patch);
          show(inboxMsg, "✅ Saved. (Insights should update instantly.)");
        } catch (err) {
          console.error(err);
          show(inboxErr, `❌ Update failed: ${err.code || ""} ${err.message || ""}`);
        }
      });

      return div;
    }

    loginBtn.addEventListener("click", async () => {
      hide(authOk); hide(authBad);
      loginBtn.disabled = true;
      loginBtn.textContent = "Signing in...";

      try {
        await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
      } catch (err) {
        console.error(err);
        show(authBad, `❌ Login failed: ${err.code || ""} ${err.message || ""}`);
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = "Sign in";
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    copyUidBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(uidText.textContent);
        copyMsg.style.display = "block";
        setTimeout(() => copyMsg.style.display = "none", 1200);
      } catch {
        // fallback
        const t = document.createElement("textarea");
        t.value = uidText.textContent;
        document.body.appendChild(t);
        t.select();
        document.execCommand("copy");
        document.body.removeChild(t);
        copyMsg.style.display = "block";
        setTimeout(() => copyMsg.style.display = "none", 1200);
      }
    });

    onAuthStateChanged(auth, async (user) => {
      hide(authOk); hide(authBad); hide(inboxMsg); hide(inboxErr);

      if (!user) {
        inboxCard.style.display = "none";
        loginBtn.style.display = "block";
        logoutBtn.style.display = "none";
        uidSection.style.display = "none";
        if (unsubscribe) { unsubscribe(); unsubscribe = null; }
        return;
      }

      uidSection.style.display = "block";
      uidText.textContent = user.uid;

      loginBtn.style.display = "none";
      logoutBtn.style.display = "block";

      // Staff access check
      try {
        const ok = await checkStaffAccess(user);

        if (!ok) {
          show(authBad, `❌ Signed in but NOT authorized. Create Firestore doc: staff/${user.uid} (copy UID button above).`);
          inboxCard.style.display = "none";
          return;
        }
      } catch (err) {
        console.error(err);
        // permission-denied usually means rules are blocking reading staff/{uid}
        show(authBad, `❌ Could not verify staff access: ${err.code || ""} ${err.message || ""}`);
        inboxCard.style.display = "none";
        return;
      }

      show(authOk, "✅ Signed in and authorized.");
      inboxCard.style.display = "block";

      // Realtime inbox
      const q = query(collection(db, "enquiries"), orderBy("createdAt", "desc"));
      if (unsubscribe) unsubscribe();
      unsubscribe = onSnapshot(q, (snap) => {
        list.innerHTML = "";
        snap.forEach(docSnap => list.appendChild(renderItem(docSnap.id, docSnap.data())));
      }, (err) => {
        console.error(err);
        show(inboxErr, `❌ Live inbox failed: ${err.code || ""} ${err.message || ""}`);
      });
    });
  </script>
</body>
</html>
