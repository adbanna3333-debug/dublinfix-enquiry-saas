<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBHl8DNvITATjqw2u8DhbopnHTPfDR_RiU",
    authDomain: "dublinfix-enquiry-saas.firebaseapp.com",
    projectId: "dublinfix-enquiry-saas",
    storageBucket: "dublinfix-enquiry-saas.firebasestorage.app",
    messagingSenderId: "677739653412",
    appId: "1:677739653412:web:5937442f4c01d075ceebb1"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const totalEl = document.getElementById("total");
  const openEl = document.getElementById("open");
  const rateEl = document.getElementById("rate");
  const rateBar = document.getElementById("rateBar");
  const last24El = document.getElementById("last24");
  const statusTable = document.getElementById("statusTable");
  const errEl = document.getElementById("err");

  // Add a tiny login UI (injected above the error box)
  const loginBox = document.createElement("div");
  loginBox.className = "card";
  loginBox.style.marginTop = "14px";
  loginBox.innerHTML = `
    <h1>Staff login (for Insights)</h1>
    <p class="muted">Use the same staff credentials as staff.html.</p>
    <label>Email</label>
    <input id="i_email" type="email" placeholder="staff@nci-demo.ie"/>
    <label>Password</label>
    <input id="i_pass" type="password" placeholder="Demo123!"/>
    <button id="i_login">Sign in</button>
    <button id="i_logout" class="secondary" style="display:none;">Sign out</button>
    <div id="i_msg" class="msg bad" style="display:none;"></div>
  `;
  errEl.parentElement.insertBefore(loginBox, errEl);

  const iEmail = loginBox.querySelector("#i_email");
  const iPass  = loginBox.querySelector("#i_pass");
  const iLogin = loginBox.querySelector("#i_login");
  const iLogout= loginBox.querySelector("#i_logout");
  const iMsg   = loginBox.querySelector("#i_msg");

  function showErr(msg){ errEl.style.display="block"; errEl.textContent = msg; }
  function hideErr(){ errEl.style.display="none"; errEl.textContent=""; }
  function showLoginErr(msg){ iMsg.style.display="block"; iMsg.textContent = msg; }
  function hideLoginErr(){ iMsg.style.display="none"; iMsg.textContent=""; }

  let unsubscribe = null;

  async function isStaff(user){
    const s = await getDoc(doc(db, "staff", user.uid));
    return s.exists();
  }

  function startInsightsRealtime(){
    const q = query(collection(db, "enquiries"));
    if (unsubscribe) unsubscribe();

    unsubscribe = onSnapshot(q, (snap) => {
      const now = Date.now();
      const dayAgo = now - (24 * 60 * 60 * 1000);

      let total = 0, resolved = 0, open = 0, last24 = 0;
      const byStatus = new Map();

      snap.forEach(d => {
        const e = d.data();
        total++;

        const status = e.status || "New";
        byStatus.set(status, (byStatus.get(status) || 0) + 1);

        if (status === "Resolved") resolved++;
        else open++;

        const created = e.createdAt?.toDate ? e.createdAt.toDate().getTime() : null;
        if (created && created >= dayAgo) last24++;
      });

      totalEl.textContent = total;
      openEl.textContent = open;

      const rate = total === 0 ? 0 : Math.round((resolved / total) * 100);
      rateEl.textContent = rate + "%";
      rateBar.style.width = rate + "%";

      last24El.textContent = last24;

      statusTable.innerHTML = "";
      const rows = Array.from(byStatus.entries()).sort((a,b) => b[1] - a[1]);
      for (const [status, count] of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td><span class="pill">${status}</span></td><td>${count}</td>`;
        statusTable.appendChild(tr);
      }

      hideErr();
    }, (err) => {
      console.error(err);
      showErr("‚ùå Insights cannot read enquiries (permission denied). Check rules + staff authorization.");
    });
  }

  iLogin.addEventListener("click", async () => {
    hideLoginErr();
    try {
      await signInWithEmailAndPassword(auth, iEmail.value.trim(), iPass.value);
    } catch (err) {
      console.error(err);
      showLoginErr(`‚ùå Login failed: ${err.code || ""}`);
    }
  });

  iLogout.addEventListener("click", async () => {
    await signOut(auth);
  });

  onAuthStateChanged(auth, async (user) => {
    hideLoginErr();

    if (!user) {
      iLogin.style.display = "inline-block";
      iLogout.style.display = "none";
      if (unsubscribe) { unsubscribe(); unsubscribe = null; }
      showErr("üîí Sign in as staff to view Insights.");
      return;
    }

    iLogin.style.display = "none";
    iLogout.style.display = "inline-block";

    try {
      const ok = await isStaff(user);
      if (!ok) {
        showErr(`‚ùå Signed in but not authorized. Create Firestore doc: staff/${user.uid}`);
        return;
      }
      startInsightsRealtime();
    } catch (err) {
      console.error(err);
      showErr("‚ùå Could not verify staff access (rules).");
    }
  });
</script>
